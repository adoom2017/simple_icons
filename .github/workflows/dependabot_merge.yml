name: "Dependabot Automerge - Action"

on:
  pull_request:
  workflow_dispatch:

jobs:
  worker:
    runs-on: ubuntu-latest
    # if: github.actor == 'dependabot[bot]'
    steps:
      # close PR
      - name: Comment close PR
        env:
          URL: ${{ github.event.pull_request.comments_url }}
          GITHUB_TOKEN: ${{ secrets.MYGITHUB_TOKEN }}
          MSG: '@dependabot close'
        run: |
          curl \
            -X POST \
            $URL \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{ "body": "$MSG" }'

    # start real build
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}

      - uses: actions/setup-node@v2
        with:
          node-version: '15.x'

      # Setup the flutter environment.
      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable' # 'dev', 'alpha', default to: 'stable'
          # flutter-version: '1.12.x' # you can also specify exact version of flutter

      - name: Install dependencies
        run: sudo apt install fonttools && sudo snap install yq
        
      - name: Get Flutter packages
        run: flutter pub get

      - name: Run build script
        run: bash ./build.sh
        working-directory: ./tool/

      - name: Set Version and Changelog
        run: bash ./set_version.sh
        working-directory: ./tool/

      - name: Varify Flutter yaml version
        run: flutter pub get

      - id: set_var
        run: |
          content=`cat ./vendor/package.json`
          # the following lines are only required for multi line json
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          # end of optional handling for multi line json
          echo "::set-output name=packageJson::$content"
          
      - name: Stach changes
        run: git add .

      - uses: stefanzweifel/git-auto-commit-action@v4
        with: 
          commit_message: "ðŸ¤– - update to ${{fromJson(steps.set_var.outputs.packageJson).dependencies.simple-icons-font}}"
          branch: ${{ github.head_ref }}
          # token: ${{ github.PAT }}

      # - name: Commit new changes
      #   run: |
      #     git config user.name github-actions
      #     git config user.email github-actions@github.com
      #     git commit -am "ðŸ¤– - update to ${{fromJson(steps.set_var.outputs.packageJson).dependencies.simple-icons-font}}"
      #     git push origin master

      # - name: automerge
      #   uses: actions/github-script@0.2.0
      #   with:
      #     script: |
      #       github.pullRequests.createReview({
      #         owner: context.payload.repository.owner.login,
      #         repo: context.payload.repository.name,
      #         pull_number: context.payload.pull_request.number,
      #         event: 'APPROVE'
      #       })
      #       github.pullRequests.merge({
      #         owner: context.payload.repository.owner.login,
      #         repo: context.payload.repository.name,
      #         pull_number: context.payload.pull_request.number
      #       })
      #     github-token: ${{github.token}}